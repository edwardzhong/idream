function getEnv(){var e=navigator.userAgent.toLowerCase();return/micromessenger(\/[\d\.]+)*/.test(e)?"weixin":/qq\/(\/[\d\.]+)*/.test(e)||/qzone\//.test(e)?"qq":e.indexOf("firefox")>-1?"ff":e.indexOf("safari")>-1?"safari":"h5"}function showDialog(e,t,o){var n="string"==typeof e,i=n?e:e.txt,a=n?"确定":e.confirm,c=n?"取消":e.cancel||"",r='<div class="dialog"><div class="dialog-text"><p>{txt}</p></div><div class="dialog-footer"><a href="javascript:;" class="confirm">{confirm}</a>'+(c?'<a href="javascript:;" class="cancel">{cancel}</a>':"");html=$(r.replace("{txt}",i).replace("{confirm}",a).replace("{cancel}",c)),$("#overlay").show(),$(document.body).append(html),html.find(".confirm").on("click",function(e){e.stopPropagation(),t&&t(),$("#overlay").hide(),html.remove(),$(".dialog").remove()}),html.find(".cancel").on("click",function(e){e.stopPropagation(),o&&o(),$("#overlay").hide(),html.remove()})}function setPlaceholder(){$(this).html()?$(this).siblings("span").hide():$(this).siblings("span").show()}function hideDialogs(){$(".down-tip").hide(),$("#search").find(".tip").hide()}function setImgPosition(e,t,o){function n(){i=t.width,a=t.height,i/a>l/s?(t.style.height="100%",c=(s/a*i-l)/2,e.scrollLeft(c)):(t.style.width="100%",r=(l/i*a-s)/2,e.scrollTop(r))}var i=0,a=0,c=0,r=0,l=e.width(),s=e.height();if(o)try{n()}catch(e){}else t.onload=function(){n(),pic=null}}function setCopyUrl(){$("[data-tag=copy]").each(function(e,t){if(!$(t).data("set")){var o=$(t).attr("data-clipboard-text"),n=new ClipboardJS(t);$(t).attr("data-clipboard-text",Host+o),$(t).data("set","1"),n.on("success",function(e){$(t).parent().parent().hide(),showDialog({txt:"链接已经复制到剪贴板",confirm:"确认"})}),n.on("error",function(e){console.log(e)})}})}function showDownMenu(e,t){var o=t.position().left;e.removeClass("down").css("top","26px"),$(window).height()-t.offset().top<e.height()&&e.css("top","-"+(e.height()+10)+"px").addClass("down"),e.css("left",o-30).show()}function showComment(e,t,o){var n=$("#comment");$("#commentText").trumbowyg("html",""),$("#comtip").html(""),$("#overlay").show(),e.length?n.find("p").html("回复 | "+e.first().html()):n.find("p").html("评论原文"),n.css({left:t,width:o}),n.show(),setTimeout(function(){$("#comment").find(".trumbowyg-editor").focus()},300)}function showWX(e){function t(e){e.stopPropagation(),$("#overlay").hide(),$(document.body).css("overflow",""),o.hide()}var o=$(".wxshare-popup");generateCode(e.sUrl),$(document.body).css("overflow","hidden"),$("#overlay").show(),o.show(),o.find(".close").on("click",t)}function generateCode(e){$("#qrcode").empty();new QRCode("qrcode",{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M})}function showShareOverlay(){var e=$('<div class="share-overlay"><i class="share-arrow"></i><p class="share-tip">分享给好友&nbsp;</p></div>');$(document.body).css("overflow","hidden").append(e),e.on("click",function(t){t.stopPropagation(),$(document.body).css("overflow",""),e.remove()})}function getShareOpts(){var e=$(this),t=e.parent().attr("data-url")||"",o=e.parents(".view-article,.dream-wrap"),n=o.find("img").length?o.find("img")[0].src:"";return{url:location.protocol+"//"+location.host,sUrl:location.protocol+"//"+location.host+t,sPic:n,sTitle:o.find("h3").html(),sDesc:o.find(".content,.text").html().replace(/\#/g,"").replace(/\<[\s\S]+?\>/g,"").substr(0,150)}}function generate(e,t){var e=e.replace(/\(sUrl\)/g,encodeURI(t.sUrl)).replace(/\(sTitle\)/g,t.sTitle).replace(/\(sDesc\)/g,t.sDesc).replace(/\(sPic\)/g,encodeURIComponent(t.sPic)).replace(/\(url\)/g,Host+encodeURIComponent(t.url));window.open(e)}function showShare(){return("weixin"==env||"qq"==env)&&(showShareOverlay(),!0)}function uploadImage(){var e=null;$("#editImgs").on("click","img",function(t){e=this,$("#replaceUpload").trigger("click")}),$("#uploadFile").on("change","input",uploadFile),$("#replaceUpload").on("change",function(t){uploadFile(t,e)})}function replaceInput(){$("#uploadFile").find("input").remove(),$("#uploadFile").append('<input type="file" name="file">')}function uploadFile(e,t){var o,n=e.target.files[0],i=n.size,a=n.type;return["image/jpg","image/jpeg","image/png"].indexOf(a)<0?void showDialog({txt:"只能上传jpg和png格式的图片",confirm:"确认"}):i>512e3?void showDialog({txt:"您上传的图片太大了，不能超过500k哦！",confirm:"确认"}):void(window.FileReader?(o=new FileReader,o.onloadend=function(e){var o,n;if(t)n=t,n.src=e.target.result,o=$(t).parent(),reqUploadImg(e.target.result,function(e){n.src=e,setImgPosition(o,n)});else{var n=new Image;n.src=e.target.result,o=$('<div class="img-wrap"><i class="icon-minus-circled" title="删除"></i><div class="img"></div></div>'),o.find(".img").append(n),$("#editImgs").append(o),reqUploadImg(e.target.result,function(e){n.src=e,setImgPosition(o.find(".img"),n)}),replaceInput()}},o.readAsDataURL(n)):showDialog({txt:"浏览器不支持上传",confirm:"确认"}))}function reqUploadImg(e,t){sendFn({r:"/login/upload-img",img:e},function(e){200==e.code&&e.data&&e.data.url&&t(e.data.url)})}function sendFn(e,t,o){var n={url:"/api",type:"POST",dataType:"json",success:function(e){$("#loading").hide(),showDialog({txt:e.msg,confirm:"确认"}),console.log(e)},error:function(e){$("#loading").hide(),showDialog({txt:"服务器错误,请稍后再试",confirm:"确认"}),console.log(e)}};o&&$.extend(n,o),$.extend(n,{data:e,success:t}),$.ajax(n)}function scrollPage(e){$(".middle").on("scroll",function(t){var o={page:pageNo+1,page_size:PageSize},n=$(".article-list"),i=$("#liTemp").html(),a=n.outerHeight(),c=($(this).offset().top,$(window).height()),r=$(this).scrollTop();$.extend(o,e),isLoading||isOver||c+r>a-100&&(isLoading=!0,sendFn(o,function(e){if(console.log(e),isLoading=!1,200==e.code&&e.data&&e.data.feed&&e.data.feed.length){PageTotal=Number(e.data.count),isOver=pageNo*PageSize+e.data.feed.length>=PageTotal,pageNo++;var t=e.data.feed,o=[],a="";t=initList(t),t.forEach(function(e,t){if(e.content=replaceTopic(e.content),a=i.replace(/\(avatar\)/,e.avatar).replace(/\(publish_time\)/,e.publish_time).replace(/\(feed_id\)/g,e.feed_id).replace(/\(uname\)/g,e.uname).replace(/\(title\)/g,e.title).replace(/\(content\)/,e.content).replace(/\(digg_count\)/,e.digg_count).replace(/\(comment_count\)/,e.comment_count).replace(/\(show_type\)/,e.show_type||""),e.imgInfo&&e.imgInfo.length){var n=[];e.imgInfo.forEach(function(e){n.push('<div class="img"><img src="'+e+'" alt="avatar"></div>')}),a=a.replace(/\(imgs\)/,n.join(""))}else a=a.replace(/\(imgs\)/,"");a=1==e.has_digg?a.replace(/\(has_digg\)/,"active"):a.replace(/\(has_digg\)/,""),a=e.show_type&&2==e.show_type?a.replace(/\(pstyle\)/,"inline").replace(/\(ptxt\)/,"公开"):a.replace(/\(pstyle\)/,"none").replace(/\(ptxt\)/,"私密"),o.push(a)}),n.append(o.join("")),setCopyUrl(),$(".article-list li").off(),setContent()}}))})}function setContent(){$(".article-list li").on("click",".text",function(){$(this).addClass("show")}),$(".article-list li").on("dblclick",".text",function(){$(this).removeClass("show")})}function replaceTopic(e,t){return e.replace(/(^|\>|\s+)\#([^\<\>\s\n]+)/g,function(e,o,n){var i=n.replace("&nbsp;","").replace(/^\s+|\s+$/,""),a=!(!t||t!=i);return o+'<a href="'+(a?"javascript:;":"/topic/"+i)+'" class="topic'+(a?" active":"")+'">#'+i+"</a>"})}function initList(e){return e.map(function(e){return e.avatar=e.avatar||"/img/avatar.jpg",e.digg_count=0==e.digg_count?"":e.digg_count,e.comment_count=0==e.comment_count?"":e.comment_count,e})}function setTextWarn(e,t){for(var o=0,n=0;n<e.length&&(/[\u4e00-\u9fa5]/.test(e.charAt(n))&&o++,!(o>t));n++);o>t?$(this).addClass("warn"):$(this).removeClass("warn")}function Storage(e){this.key=e}var changeEvent="oninput"in window?"input":"onpropertychange"in window?"propertychange":"keyup",env=getEnv();$(".edit-div").each(function(e,t){"weixin"!=env&&"safari"!=env||$(t).css("-webkit-user-select","auto");var o=$(t).attr("placeholder");o&&($(t).wrap('<div class="edit-wrap"></div>'),$(t).parent().append("<span>"+o+"</span>"),$(t).on(changeEvent,setPlaceholder),setPlaceholder.call(t))}),$("#setUp").mouseenter(function(e){$("#setMenu").show()}).mouseleave(function(e){$("#setMenu").hide()}),$(document.body).on("click",function(){hideDialogs()}),$("#scrollPos").on("click",function(e){e.stopPropagation(),$(".middle").scrollTop(0)}).on("dblclick",function(e){e.stopPropagation();var t=$(".middle")[0].scrollHeight;$(".middle").scrollTop(t)}),$("#logOut").on("click",function(e){e.stopPropagation(),showDialog("退出账户?",function(){sendFn({r:"/login/signout"},function(e){location.href="/login"},{url:"/logout"})})}),$("#replyComment").on("click",function(e){e.stopPropagation();var t=$("#commentText").trumbowyg("html"),o=$("#comtip");if(!t)return void o.html("内容不能为空");o.html(""),$("#loading").show(),$("#overlay").hide(),$("#comment").hide(),sendFn({r:"/feed/review",feed_id:FeedID,content:t},function(e){$("#loading").hide(),200==e.code?console.log(e):showDialog({txt:e.msg,confirm:"确认"})})});var isLoading=!1,pageNo=1,isOver=FirstCount>=PageTotal;Storage.prototype={save:function(e){var t=JSON.stringify(e);localStorage.setItem(this.key,t)},get:function(){var e=localStorage.getItem(this.key),t={};try{t=JSON.parse(e)}catch(e){console.log(e)}return t},clear:function(){localStorage.clear(this.key)}};