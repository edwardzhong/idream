function selectHash(e){if(location.hash.substr(1)!=e)return void(location.hash=e);var a=e.split("/"),t=a[0];t&&t in Actions?(activePage(t),pageID=t,Actions[t].apply(this,a),firstLoad=!1):selectHash("dream")}function afterLoad(e){pageInfo[e].firstLoad?(options.page=1,renderList(scrollPage)):scrollPage(),pageInfo[e].firstLoad=!1}function activePage(e){$(".middle").off(),$(".search-pages").find("[data-tag="+e+"]").show().siblings().hide(),$(".middle").scrollTop(0),$("#serachNav").find("[data-tag="+e+"]").addClass("active").siblings(".active").removeClass("active")}function scrollPage(){$(".middle").on("scroll",function(e){var a=$("#"+pageID+"List"),t=a.outerHeight(),i=($(this).offset().top,$(window).height()),s=$(this).scrollTop();isLoading||pageInfo[pageID].isOver||i+s>t-100&&(isLoading=!0,options.page=pageInfo[pageID].page+1,renderList())})}function renderList(e){if(Keyword){var a=$("#"+pageID+"List"),t=a.prev(".no-list"),i=$("user"==pageID?"#userTemp":"#liTemp").html();console.log(options),t.hide(),sendFn(options,function(s){if(console.log(s),isLoading=!1,200==s.code){var o=s.data;if(o&&"feed"in o&&(o.data=o.feed),o&&o.data&&o.data.length){t.hide(),pageInfo[pageID].total=Number(o.count),pageInfo[pageID].page*PageSize+o.data.length>=pageInfo[pageID].total?pageInfo[pageID].isOver=!0:pageInfo[pageID].isOver=!1,pageInfo[pageID].page++;var n=o.data,r=[],c="";n=initList(n),n.forEach(function(e,a){if(e.content&&(e.content=replaceTopic(e.content)),c=i.replace(/\(avatar\)/,e.avatar).replace(/\(uid\)/g,e.uid).replace(/\(publish_time\)/,e.publish_time).replace(/\(feed_id\)/g,e.feed_id).replace(/\(uname\)/g,e.uname).replace(/\(title\)/g,e.title).replace(/\(content\)/,e.content).replace(/\(digg_count\)/,e.digg_count||"").replace(/\(comment_count\)/,e.comment_count||"").replace(/\(show_type\)/,e.show_type||"").replace(/\(intro\)/,e.intro||"&nbsp;"),e.imgInfo&&e.imgInfo.length){var t=[];e.imgInfo.forEach(function(e){t.push('<div class="img"><img src="'+e+'" alt="avatar"></div>')}),c=c.replace(/\(imgs\)/,t.join(""))}else c=c.replace(/\(imgs\)/,"");c=1==e.has_digg?c.replace(/\(has_digg\)/,"active"):c.replace(/\(has_digg\)/,""),c=1==e.is_me?c.replace(/\(mstyle\)/,"inline"):c.replace(/\(mstyle\)/,"none"),c=e.show_type&&2==e.show_type?c.replace(/\(pstyle\)/,"inline").replace(/\(ptxt\)/,"公开"):c.replace(/\(pstyle\)/,"none").replace(/\(ptxt\)/,"私密"),r.push(c)}),a.append(r.join("")),setCopyUrl(),$(".article-list li").off(),setContent()}else t.html("暂时未搜索到结果").show()}else t.html(s.msg).show();e&&setTimeout(e,300)})}}function bindEvents(){$("#search").find("input").on(changeEvent,function(e){var a=$("#search"),t=$(this).val(),i=a.find(".tip");i.find("p").html(t),t?i.show():i.hide()}),$(document).on("keydown",function(e){var a=$.trim($("#search").find("input").val());13==e.keyCode&&a&&($("#search").find(".tip").hide(),location.href="/search?kw="+a+location.hash)}),$(".article-list li").on("click","p",function(){$(this).addClass("show")}),$(".article-list li").on("dblclick","p",function(){$(this).removeClass("show")}),$("#comment").on("click",".close",function(e){e.stopPropagation(),$(this).parent().hide(),$("#overlay").hide()}),$("#replyComment").on("click",function(e){e.stopPropagation();var a=$("#commentText");if(!$.trim(a.html()))return a.addClass("flash"),void setTimeout(function(){a.removeClass("flash")},900);$("#loading").show(),$("#overlay").hide(),$("#comment").hide(),sendFn({r:"/feed/review",feed_id:FeedID,content:a.html()},function(e){$("#loading").hide(),200==e.code?console.log(e):showDialog({txt:e.msg,confirm:"确认"})})}),$(".article-list").on("click","[data-tag]",function(e){e.stopPropagation();var a=$(this);switch(name=a.data("tag"),fid=a.data("id"),opts={},name){case"up":sendFn({r:"/feed/digg",feed_id:fid},function(e){$("#loading").hide(),200==e.code?(a.toggleClass("active"),console.log(e)):showDialog({txt:e.msg,confirm:"确认"})});break;case"more":hideDialogs();var t=$(this).siblings("[data-menu=more]");showDownMenu(t,$(this));break;case"share":hideDialogs();var t=$(this).siblings("[data-menu=share]");showDownMenu(t,$(this));break;case"delete":var a=$(this);showDialog("确定删除?",function(){sendFn({r:"/user/del",feed_id:fid},function(e){200==e.code?a.parents("ul").length&&a.parentsUntil("ul").remove():showDialog({txt:e.msg,confirm:"确认"})})});break;case"private":hideDialogs();var a=$(this),i=a.parentsUntil(".actions").siblings(".private"),s=Number(a.data("type"));sendFn({r:"/feed/set-feed-secret",feed_id:fid,show_type:3-s},function(e){200==e.code?(i.toggle(),a.data("type",3-s),a.html(["设为公开","设为私密"][s-1])):showDialog({txt:e.msg,confirm:"确认"})});break;case"collect":hideDialogs(),showDialog({txt:"已收藏",confirm:"确认"});break;case"copy":break;case"comment":var o=$(this).parents(".dream-wrap"),n=o.find(".title span"),r=o.offset().left,c=o.width();showComment(n,r,c),FeedID=fid;break;case"facebook":if(showShare())break;generate("https://www.facebook.com/sharer/sharer.php?u=(sUrl)",getShareOpts.call(this));break;case"weibo":if(showShare())break;generate("http://service.weibo.com/share/share.php?url=(sUrl)&title=(sTitle)&pic=(sPic)",getShareOpts.call(this));break;case"douban":if(showShare())break;generate("https://www.douban.com/share/service?image=(sPic)&href=(sUrl)&name=(sTitle)&text=(sDesc)",getShareOpts.call(this));break;case"qq":if(showShare())break;generate("http://connect.qq.com/widget/shareqq/index.html?url=(sUrl)&title=(sTitle)&source=(sDesc)",getShareOpts.call(this));break;case"wechat":if(showShare())break;showWX(getShareOpts.call(this));break;case"whatsapp":if(showShare())break;generate("whatsapp://send?text=(sDesc)"+encodeURIComponent("\n\n")+"(sUrl)&via=lopscoop",getShareOpts.call(this))}})}var FeedID=0,firstLoad=!0,isLoading=!1,pageID="dream",pageInfo={dream:{page:0,total:0,firstLoad:!0,isOver:!1},user:{page:0,total:0,firstLoad:!0,isOver:!1},picture:{page:0,total:0,firstLoad:!0,isOver:!1},my:{page:0,total:0,firstLoad:!0,isOver:!1}},options={page_size:PageSize,keyword:Keyword},Actions={dream:function(){$.extend(options,{r:"/feed/explore",has_img:""}),afterLoad("dream")},user:function(){$.extend(options,{r:"/feed/users-search",uname:Keyword,has_img:""}),afterLoad("user")},picture:function(){$.extend(options,{r:"/feed/explore",has_img:2}),afterLoad("picture")},my:function(){$.extend(options,{r:"/user/get-user-home",has_img:""}),afterLoad("my")}};$(window).on("hashchange",function(e){selectHash(location.hash.replace("#",""))}),selectHash(location.hash.substr(1)),setTimeout(function(){$("#search").find("input").focus().val(Keyword)},300),setCopyUrl(),bindEvents();