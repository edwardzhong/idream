function cutPicture(){var e=$(img).cropper("getData"),t=document.createElement("canvas"),o=t.getContext("2d"),i="";t.width=e.width,t.height=e.height,o.drawImage(img,e.x,e.y,e.width,e.height,0,0,t.width,t.height),i=t.toDataURL("image/jpeg"),$("#avatar").find("img").attr("src",i),reqUploadImg(i,function(e){$("#avatar").find("img").attr("src",e)})}function destroyImg(){$(img).cropper("destroy"),$("#popImg").hide().find("img").remove(),$("#overlay").hide(),$(document).off("keydown"),$("#popImg").off("dblclick"),$("#replaceUpload").remove(),$(document.body).append('<input type="file" name="file" id="replaceUpload" class="replace-upload">')}var img;$("#intro").trumbowyg({svgPath:!1,resetCss:!0,removeformatPasted:!0,hideButtonTexts:!0,autogrow:!0,autogrowOnEnter:!0}),setTimeout(function(){$(".edit-user .trumbowyg-editor").focus(),setTimeout(function(){$("#btn").focus()},50)},300),$("#popImg").on("click",".close",destroyImg),$(document.body).on("change","#replaceUpload",function(e){var t,o=e.target.files[0],i=o.size,n=o.type,a=$("#popImg");return["image/jpg","image/jpeg","image/png"].indexOf(n)<0?void showDialog({txt:"只能上传jpg和png格式的图片",confirm:"确认"}):i>307200?void showDialog({txt:"您上传的图片太大了，不能超过300k哦！",confirm:"确认"}):void(window.FileReader?(t=new FileReader,t.onloadend=function(e){img=new Image,img.src=e.target.result,img.onload=function(){a.prepend(img).show(),$(img).cropper({aspectRatio:1,viewMode:1}),$("#overlay").show(),$(document).on("keydown",function(e){13==e.keyCode&&(cutPicture(),destroyImg())}),$("#popImg").on("dblclick",function(){cutPicture(),destroyImg()})}},t.readAsDataURL(o)):showDialog({txt:"浏览器不支持上传",confirm:"确认"}))}),$("#avatar").on("click",function(e){$("#replaceUpload").trigger("click")}),$("#year").on(changeEvent,function(e){var t=this.value;t=t.replace(/\D+/,""),$(this).val(t)}),$("#name").on(changeEvent,function(e){setTextWarn.call(this,this.value,7)}),$("#job,#loc").on(changeEvent,function(e){setTextWarn.call(this,this.value,7)}),$(".edit-user .trumbowyg-editor").on(changeEvent,function(e){var t=$(".edit-user .trumbowyg-editor").html();setTextWarn.call($(".edit-user .trumbowyg-editor")[0],t,150)}),$("#btn").on("click",function(e){e.stopPropagation(),showDialog({txt:"确定保存吗？",confirm:"确认"},function(){var e=$("#avatar").find("img").attr("src"),t=$("#name").val(),o=$("#intro").trumbowyg("html"),i=$("[name=gender]:checked").data("id")||0,n=$("#age").val(),a=$("#job").val(),r=$("#loc").val();$("#loading").show(),sendFn({r:"/user/edit-user",avatar:e,uname:t,intro:o,sex:i,location:r,job:a,age:n},function(e){$("#loading").hide(),200==e.code?location.href="/":showDialog({txt:e.msg,confirm:"确认"})})})});