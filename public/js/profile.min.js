function cutPicture(){var e=$(img).cropper("getData"),t=document.createElement("canvas"),o=t.getContext("2d"),a="";t.width=e.width,t.height=e.height,o.drawImage(img,e.x,e.y,e.width,e.height,0,0,t.width,t.height),a=t.toDataURL("image/jpeg"),$("#avatar").find("img").attr("src",a),reqUploadImg(a,function(e){$("#avatar").find("img").attr("src",e)})}function destroyImg(){$(img).cropper("destroy"),$("#popImg").hide().find("img").remove(),$("#overlay").hide(),$(document).off("keydown"),$("#popImg").off("dblclick"),$("#replaceUpload").remove(),$(document.body).append('<input type="file" name="file" id="replaceUpload" class="replace-upload">')}var img;setTimeout(function(){CKEDITOR.instances.intro.focus(),setTimeout(function(){CKEDITOR.instances.name.focus(),$("#btn").focus()},30)},300),$("#popImg").on("click",".close",destroyImg),$(document.body).on("change","#replaceUpload",function(e){var t,o=e.target.files[0],a=o.size,n=o.type,i=$("#popImg");return["image/jpg","image/jpeg","image/png"].indexOf(n)<0?void showDialog({txt:"只能上传jpg和png格式的图片",confirm:"确认"}):a>307200?void showDialog({txt:"您上传的图片太大了，不能超过300k哦！",confirm:"确认"}):void(window.FileReader?(t=new FileReader,t.onloadend=function(e){img=new Image,img.src=e.target.result,img.onload=function(){i.prepend(img).show(),$(img).cropper({aspectRatio:1,viewMode:1}),$("#overlay").show(),$(document).on("keydown",function(e){13==e.keyCode&&(cutPicture(),destroyImg())}),$("#popImg").on("dblclick",function(){cutPicture(),destroyImg()})}},t.readAsDataURL(o)):showDialog({txt:"浏览器不支持上传",confirm:"确认"}))}),$("#avatar").on("click",function(e){$("#replaceUpload").trigger("click")}),$("#year").on(changeEvent,function(e){var t=this.value;t=t.replace(/\D+/,""),$(this).val(t)}),$("#job,#loc").on(changeEvent,function(e){setTextWarn.call(this,this.value,7)}),$("#btn").on("click",function(e){e.stopPropagation(),showDialog({txt:"确定保存吗？",confirm:"确认"},function(){var e=$("#avatar").find("img").attr("src"),t=CKEDITOR.instances.name.getData(),o=CKEDITOR.instances.intro.getData(),a=$("[name=gender]:checked").data("id")||0,n=$("#age").val(),i=$("#job").val(),c=$("#loc").val();$("#loading").show(),sendFn({r:"/user/edit-user",avatar:e,uname:t,intro:o,sex:a,location:c,job:i,age:n},function(e){$("#loading").hide(),200==e.code?location.href="/":showDialog({txt:e.msg,confirm:"确认"})})})});